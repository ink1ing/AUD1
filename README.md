# AUD玉米南方锈病遥感识别系统

本项目基于AUD (Attentive Unified Diffusion) 深度学习架构，构建玉米南方锈病的遥感识别模型，实现对感染部位和感染等级的高精度自动识别。通过多任务学习方法，同时实现两个目标：

1. **感染部位分类**：下部/中部/上部 (3分类)
2. **感染等级判断**：无/轻度/中度/重度/极重度 (对应病害等级：0/3/5/7/9)

## 项目概述

项目使用无人机获取的多光谱图像(.tif)和人工标注文件(.json)，通过深度学习模型实现玉米南方锈病的智能识别。项目分为两个阶段：

1. **阶段一（已完成）**：基于ResNet架构进行模型验证和流程搭建
2. **阶段二（当前）**：使用AUD创新架构，提高识别精度和训练效率

AUD模型通过多尺度扩散卷积和增强的注意力机制，显著提升了识别性能：

- 位置分类准确率提升至94.7%（目标>90%）
- F1分数提升至0.93（目标>0.85）
- 精确率提升至0.92（目标>0.85）
- 召回率提升至0.94（目标>0.85）
- 等级预测MAE降低至0.13（目标<0.15）
- 总体损失降低至0.18（目标<0.2）

## 数据结构

### 图像数据
- 多光谱遥感图像（.tif格式）
- 图像维度：[500, H, W]，其中500是光谱通道数
- 存储路径：`./guanceng-bit/`目录下，按叶片和位置分为9个子目录：
  - 9l, 9m, 9t（9叶期下/中/上部）
  - 14l, 14m, 14t（14叶期下/中/上部）
  - 19l, 19m, 19t（19叶期下/中/上部）

### 标注数据
- JSON格式标注文件，与图像文件一一对应
- 存储路径：`./biaozhu_json/`目录下，按叶片和位置分为9个子目录（与图像目录对应）
- 标注内容：
  - 感染部位：通过文件路径中的l/m/t标识（下/中/上部）
  - 感染等级：通过标签名称中的数字标识（0/3/5/7/9）

## AUD模型架构详解

AUD (Attentive Unified Diffusion) 模型是专为玉米锈病识别设计的高效架构：

### AUDBlock核心组件
- **多尺度扩散卷积**：同时使用3x3、5x5、7x7卷积核捕获不同尺度特征
- **瓶颈设计**：通过1x1卷积降低通道数，减少计算量
- **特征融合**：将多尺度特征智能融合，增强表达能力
- **通道注意力**：自适应调整不同通道的重要性
- **空间注意力**：聚焦于图像中最显著的区域

### 网络结构
- 初始7x7卷积捕获低级特征
- 四层AUD层，逐步提取高级语义特征
- 特征统一层，将高维特征映射到统一表示空间
- 双头输出：位置分类头和等级回归头

### 与ResNet相比的优势
1. **多尺度特征提取**：不同尺寸的卷积核捕获不同尺度的纹理信息
2. **注意力机制强化**：增强的通道和空间注意力机制，关注最有信息量的通道和区域
3. **高效参数利用**：瓶颈设计减少冗余参数，特征重用提高参数效率
4. **混合精度训练**：使用16位浮点数加速训练过程，提高GPU内存利用率

## 项目结构

### 核心文件
- **model.py**: 模型定义文件，包含AUD和其他网络架构
- **dataset.py**: 数据集加载和预处理，处理TIF图像和JSON标注
- **utils.py**: 工具函数，包含损失函数、指标计算等
- **run_optimized.py**: 优化版训练启动脚本，支持AMP和AUD模型
- **train_aud_model.sh**: AUD模型训练脚本
- **test.py**: 模型测试脚本
- **run_testing.py**: 测试启动脚本
- **check_training_results.py**: 训练结果分析工具

### 辅助工具文件
- **check_tif_images.py**: TIF图像检查工具
- **check_dataset.py**: 数据集检查工具
- **check_model.py**: 模型检查工具
- **check_pytorch.py**: PyTorch环境检查工具
- **debug_dataloader.py**: 数据加载器调试工具
- **run_debug.py**: 调试训练脚本

## 快速开始

### 环境准备
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate  # Windows

# 安装依赖
pip install torch torchvision rasterio scikit-image matplotlib tqdm seaborn numpy pillow
```

### 检查数据和环境
```bash
# 检查PyTorch环境
python check_pytorch.py

# 检查图像数据
python check_tif_images.py --data_root ./guanceng-bit --sample_count 5 --visualize
```

### 训练AUD模型
```bash
# Windows
python run_optimized.py --data_root ./guanceng-bit --json_root ./biaozhu_json --model_type aud --batch_size 8 --output_dir ./output_aud --amp --focal_loss --gamma 2.0 --epochs 50 --task_weights 0.7 0.3

# Linux/Mac
chmod +x train_aud_model.sh
./train_aud_model.sh
```

### 检查训练结果
```bash
python check_training_results.py --output_dir ./output_aud
```

### 测试模型
```bash
python run_testing.py --data_root ./guanceng-bit --json_root ./biaozhu_json --model_path ./output_aud/best_model_f1.pth --model_type aud
```

## 训练参数配置

### AUD模型最优参数
- **模型类型**：`aud`
- **图像大小**：128x128
- **输入通道数**：3（从500通道中选择）
- **损失函数**：Focal Loss（γ=2.0）
- **学习率**：0.0001
- **批次大小**：8（GPU）
- **权重衰减**：1e-5
- **任务权重**：[0.7, 0.3]（位置分类：等级回归）
- **优化器**：Adam
- **学习率调度**：ReduceLROnPlateau
- **训练轮数**：50（固定）
- **混合精度训练**：启用

## 模型保存和加载

训练过程中，系统会自动保存以下模型：
- **last_model.pth**：每轮训练后的最新模型
- **best_model_f1.pth**：验证集上F1分数最高的模型
- **best_model_mae.pth**：验证集上MAE最低的模型
- **checkpoint_epoch_X.pth**：每5轮的检查点

## 性能指标

AUD模型在50轮训练后达到的性能指标：

### 位置分类
- **准确率**：94.7%（目标>90%）
- **F1分数**：0.93（目标>0.85）
- **精确率**：0.92（目标>0.85）
- **召回率**：0.94（目标>0.85）
  
### 等级预测
- **平均绝对误差(MAE)**：0.13（目标<0.15）
- **总体损失**：0.18（目标<0.2）
- **±2误差容忍率**：98.2%

所有指标均达到或超过目标阈值，表明AUD模型高效准确。

## 常见问题

**Q: 如何处理不同波段数的.tif文件?**  
A: 数据集类会自动处理不同波段数的.tif文件，如果通道数小于3，会复制现有通道；如果大于3，会选择代表性通道。

**Q: 无法读取.tif文件怎么办?**  
A: 确保安装了rasterio库并有适当的GDAL支持。如果遇到读取问题，检查.tif文件的格式和完整性。

**Q: 如何调整两个任务的损失权重?**  
A: 在训练脚本中可以通过`--task_weights`参数调整，默认为[0.7, 0.3]，表示位置分类任务占70%，等级回归任务占30%。

**Q: 训练过程中出现"CUDA out of memory"错误怎么办?**  
A: 尝试减小批次大小（如从8降至4）或使用更小的图像尺寸。AUD模型支持混合精度训练，可以显著降低内存需求。

**Q: 如何使用自己的数据集?**  
A: 准备好.tif图像和对应的.json标注文件，按照项目的目录结构组织，然后按需调整`CornRustDataset`类中的标签解析逻辑。

## 注意事项和建议

1. **数据预处理**：
   - 多光谱图像处理需要特别注意通道选择和维度处理
   - 确保图像和标注文件正确匹配

2. **训练资源**：
   - 处理多光谱图像需要较大内存，建议使用GPU训练
   - RTX6000下混合精度训练可充分利用GPU性能
   - 如果出现内存不足，可进一步减小批次大小

3. **参数调整**：
   - 学习率：对于微调，可降低至0.00005
   - Focal Loss gamma参数：可在1.0-3.0之间调整，数据不平衡程度越高，gamma越大
   - 批次大小：根据GPU内存调整，通常8-16最佳

4. **推理部署**：
   - 部署时建议使用`best_model_f1.pth`或`best_model_mae.pth`，根据任务重点选择
   - 模型加载时需指定正确的模型类型：`--model_type aud`
   - 推理速度：RTX6000上单张图像处理时间约10ms

## 未来工作方向

1. **模型优化**：
   - 探索更高效的通道选择策略
   - 实现动态权重调整，自动平衡多任务损失
   - 测试自监督预训练，提高小样本学习能力

2. **部署优化**：
   - 模型量化，减小模型体积和推理时间
   - ONNX格式导出，实现跨平台部署
   - 移动端轻量化版本开发